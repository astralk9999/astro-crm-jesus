---
import Layout from '../../../layouts/Layout.astro';
import { isAuthenticated, isAdmin } from '../../../lib/services/authService';
import { getClientById } from '../../../lib/services/clientsService';

// Verificar autenticación y permisos
const token = Astro.cookies.get('sb-access-token')?.value;
const authenticated = await isAuthenticated(token);
if (!authenticated) {
  return Astro.redirect('/login');
}

const hasAdminPermission = await isAdmin(token);
if (!hasAdminPermission) {
  return Astro.redirect('/clientes');
}

// Obtener el ID del cliente de los parámetros
const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/clientes');
}

// Obtener información del cliente
const clientResponse = await getClientById(id, token);
if (!clientResponse.success || !clientResponse.data) {
  return Astro.redirect('/clientes');
}

const client = clientResponse.data;
---

<Layout title={`Editar Cliente - ${client.name} - SoftControl CRM`}>
  <div class="container mx-auto px-4 py-8">
    <!-- Encabezado -->
    <div class="mb-8">
      <div class="flex items-center gap-2 text-sm text-gray-600 mb-4">
        <a href="/clientes" class="hover:text-blue-600">Clientes</a>
        <span>/</span>
        <a href={`/clientes/${id}`} class="hover:text-blue-600">{client.name}</a>
        <span>/</span>
        <span>Editar</span>
      </div>
      <h1 class="text-3xl font-bold text-gray-900">Editar Cliente</h1>
      <p class="text-gray-600 mt-2">Modifica la información del cliente</p>
    </div>

    <!-- Formulario -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <form id="editClientForm" class="space-y-6">
        <input type="hidden" id="clientId" value={id} />
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Nombre -->
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
              Nombre completo <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              value={client.name}
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Juan Pérez"
            />
          </div>

          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
              Correo electrónico <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              value={client.email}
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="cliente@ejemplo.com"
            />
          </div>

          <!-- Teléfono -->
          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
              Teléfono
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              value={client.phone || ''}
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="+52 555 123 4567"
            />
          </div>

          <!-- Empresa -->
          <div>
            <label for="company" class="block text-sm font-medium text-gray-700 mb-2">
              Empresa
            </label>
            <input
              type="text"
              id="company"
              name="company"
              value={client.company || ''}
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Nombre de la empresa"
            />
          </div>
        </div>

        <!-- Información adicional -->
        <div class="pt-4 border-t">
          <p class="text-sm text-gray-500">
            Cliente creado el {new Date(client.created_at).toLocaleDateString('es-ES', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })}
          </p>
        </div>

        <!-- Botones -->
        <div class="flex justify-end gap-4 pt-4 border-t">
          <a href={`/clientes/${id}`} class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
            Cancelar
          </a>
          <button
            type="submit"
            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Mensaje de éxito -->
  <div id="successMessage" class="hidden fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50" role="alert">
    <span class="block sm:inline">Cliente actualizado exitosamente</span>
  </div>

  <!-- Mensaje de error -->
  <div id="errorMessage" class="hidden fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50" role="alert">
    <span class="block sm:inline" id="errorText">Error al actualizar el cliente</span>
  </div>

  <script>
    import { updateClient } from '../../../lib/services/clientsService';

    const form = document.getElementById('editClientForm');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const clientIdInput = document.getElementById('clientId');

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const clientId = clientIdInput?.value;
      if (!clientId) return;

      const formData = new FormData(form);
      const clientData = {
        name: formData.get('name'),
        email: formData.get('email'),
        phone: formData.get('phone') || undefined,
        company: formData.get('company') || undefined,
      };

      try {
        const response = await updateClient(clientId, clientData);
        
        if (response.success) {
          // Mostrar mensaje de éxito
          successMessage?.classList.remove('hidden');
          
          // Redirigir después de 2 segundos
          setTimeout(() => {
            window.location.href = `/clientes/${clientId}`;
          }, 2000);
        } else {
          // Mostrar mensaje de error
          if (errorText) {
            errorText.textContent = response.error || 'Error al actualizar el cliente';
          }
          errorMessage?.classList.remove('hidden');
          
          // Ocultar mensaje después de 5 segundos
          setTimeout(() => {
            errorMessage?.classList.add('hidden');
          }, 5000);
        }
      } catch (error) {
        // Mostrar mensaje de error genérico
        if (errorText) {
          errorText.textContent = 'Error inesperado al actualizar el cliente';
        }
        errorMessage?.classList.remove('hidden');
        
        setTimeout(() => {
          errorMessage?.classList.add('hidden');
        }, 5000);
      }
    });
  </script>
</Layout>

<style>
  /* ============================================
     EDITAR CLIENTE - ESTILO FUTURISTA NEÓN
     ============================================ */
  
  /* Textos */
  h1, .text-gray-900 {
    color: #ffffff !important;
  }
  
  h1 {
    text-shadow: 0 0 30px rgba(0, 255, 242, 0.2);
  }
  
  .text-gray-600, .text-gray-500 {
    color: #94a3b8 !important;
  }
  
  .text-gray-700, .text-gray-800 {
    color: #cbd5e1 !important;
  }
  
  /* Breadcrumb */
  .text-sm.text-gray-600 a {
    color: #00fff2 !important;
    transition: all 0.3s;
  }
  
  .text-sm.text-gray-600 a:hover {
    text-shadow: 0 0 10px rgba(0, 255, 242, 0.5);
  }
  
  /* Card del formulario */
  .bg-white {
    background: rgba(10, 15, 25, 0.8) !important;
    border: 1px solid rgba(0, 255, 242, 0.15) !important;
    backdrop-filter: blur(10px);
  }
  
  /* Labels */
  label {
    color: #cbd5e1 !important;
  }
  
  .text-red-500 {
    color: #ff2d95 !important;
  }
  
  /* Inputs */
  input[type="text"],
  input[type="email"],
  input[type="tel"] {
    background: rgba(255, 255, 255, 0.03) !important;
    border: 1px solid rgba(0, 255, 242, 0.2) !important;
    color: #ffffff !important;
    transition: all 0.3s;
  }
  
  input:focus {
    border-color: #00fff2 !important;
    box-shadow: 0 0 20px rgba(0, 255, 242, 0.2) !important;
    outline: none !important;
  }
  
  input::placeholder {
    color: #64748b !important;
  }
  
  /* Bordes */
  .border-t {
    border-color: rgba(0, 255, 242, 0.1) !important;
  }
  
  .border-gray-300 {
    border-color: rgba(255, 255, 255, 0.2) !important;
  }
  
  /* Botón Cancelar */
  a.border-gray-300 {
    background: rgba(255, 255, 255, 0.03) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: #cbd5e1 !important;
    transition: all 0.3s;
  }
  
  a.border-gray-300:hover {
    border-color: rgba(0, 255, 242, 0.3) !important;
    color: #00fff2 !important;
    background: rgba(0, 255, 242, 0.05) !important;
  }
  
  /* Botón Guardar */
  button[type="submit"] {
    background: linear-gradient(135deg, rgba(0, 255, 242, 0.2), rgba(0, 180, 255, 0.2)) !important;
    border: 1px solid #00fff2 !important;
    color: #00fff2 !important;
    box-shadow: 0 0 20px rgba(0, 255, 242, 0.3);
    transition: all 0.3s;
  }
  
  button[type="submit"]:hover {
    box-shadow: 0 0 30px rgba(0, 255, 242, 0.5);
    transform: translateY(-2px);
  }
  
  /* Mensajes de éxito y error */
  #successMessage {
    background: rgba(0, 255, 136, 0.15) !important;
    border: 1px solid rgba(0, 255, 136, 0.4) !important;
    color: #00ff88 !important;
  }
  
  #errorMessage {
    background: rgba(255, 45, 149, 0.15) !important;
    border: 1px solid rgba(255, 45, 149, 0.4) !important;
    color: #ff2d95 !important;
  }
</style>
