---
import Layout from '../../layouts/Layout.astro';
import { isAuthenticated, getUserProfile } from '../../lib/services/authService';
import { getClients } from '../../lib/services/clientsService';

// Verificar autenticación
const token = Astro.cookies.get('sb-access-token')?.value;
const authenticated = await isAuthenticated(token);
if (!authenticated) {
  return Astro.redirect('/login');
}

// Obtener perfil del usuario
const userProfile = await getUserProfile(token);

// Obtener lista de clientes
const clientsResponse = await getClients(token);
const clients = clientsResponse.success ? clientsResponse.data : [];
---

<Layout title="Gestión de Clientes - SoftControl CRM">
  <div class="page-container">
    <!-- Encabezado de página -->
    <header class="page-header animate-in">
      <div class="header-info">
        <div class="header-icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </div>
        <div>
          <h1>Clientes</h1>
          <p>Gestiona la información de tus clientes</p>
        </div>
      </div>
      {userProfile?.role === 'admin' && (
        <a href="/clientes/nuevo" class="btn-primary">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Nuevo Cliente
        </a>
      )}
    </header>

    <!-- Barra de búsqueda mejorada -->
    <div class="search-section animate-in animate-delay-1">
      <div class="search-wrapper">
        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input
          type="text"
          id="searchInput"
          placeholder="Buscar clientes por nombre, email o empresa..."
          class="search-input"
        />
      </div>
      <div class="search-stats">
        <span class="stats-badge">{clients?.length || 0} clientes</span>
      </div>
    </div>

    <!-- Tabla de clientes -->
    <div class="table-container animate-in animate-delay-2">
      <table>
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Contacto</th>
            <th>Empresa</th>
            <th>Fecha de Registro</th>
            <th class="text-right">Acciones</th>
          </tr>
        </thead>
        <tbody id="clientsTableBody">
          {clients && clients.length > 0 ? (
            clients.map((client, index) => (
              <tr class="table-row-animated" style={`animation-delay: ${index * 0.05}s`}>
                <td>
                  <div class="client-cell">
                    <div class="client-avatar">{client.name?.charAt(0) || 'C'}</div>
                    <span class="client-name">{client.name}</span>
                  </div>
                </td>
                <td>
                  <div class="contact-info">
                    <span class="email">{client.email}</span>
                    {client.phone && <span class="phone">{client.phone}</span>}
                  </div>
                </td>
                <td>
                  <span class="company-name">{client.company || '-'}</span>
                </td>
                <td>
                  <span class="date">{new Date(client.created_at).toLocaleDateString('es-ES')}</span>
                </td>
                <td>
                  <div class="actions-cell">
                    <a href={`/clientes/${client.id}`} class="action-btn view" title="Ver detalles">
                      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                    </a>
                    {userProfile?.role === 'admin' && (
                      <>
                        <a href={`/clientes/${client.id}/editar`} class="action-btn edit" title="Editar">
                          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                          </svg>
                        </a>
                        <button 
                          data-client-id={client.id}
                          data-client-name={client.name}
                          class="action-btn delete delete-client"
                          title="Eliminar"
                        >
                          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                        </button>
                      </>
                    )}
                  </div>
                </td>
              </tr>
            ))
          ) : (
            <tr>
              <td colspan="5">
                <div class="empty-table">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  <p>No hay clientes registrados</p>
                  <a href="/clientes/nuevo" class="empty-action">Agregar primer cliente</a>
                </div>
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal de confirmación de eliminación -->
  <div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3 text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
          <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
        </div>
        <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Confirmar eliminación</h3>
        <div class="mt-2 px-7 py-3">
          <p class="text-sm text-gray-500">
            ¿Estás seguro de que deseas eliminar al cliente <span id="clientNameToDelete" class="font-semibold"></span>? 
            Esta acción no se puede deshacer.
          </p>
        </div>
        <div class="items-center px-4 py-3">
          <button id="confirmDelete" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-24 mr-2 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
            Eliminar
          </button>
          <button id="cancelDelete" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-24 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { deleteClient } from '../../lib/services/clientsService';

    // Búsqueda local de clientes (filtrado en el DOM)
    const searchInput = document.getElementById('searchInput') as HTMLInputElement;
    const tableRows = document.querySelectorAll('#clientsTableBody tr.table-row-animated');
    const statsBadge = document.querySelector('.stats-badge');

    searchInput?.addEventListener('input', (e) => {
      const searchTerm = (e.target as HTMLInputElement).value.toLowerCase().trim();

      let visibleCount = 0;
      tableRows.forEach(row => {
        const rowElement = row as HTMLElement;
        const clientName = rowElement.querySelector('.client-name')?.textContent?.toLowerCase() || '';
        const email = rowElement.querySelector('.email')?.textContent?.toLowerCase() || '';
        const company = rowElement.querySelector('.company-name')?.textContent?.toLowerCase() || '';

        if (searchTerm === '' || 
            clientName.includes(searchTerm) || 
            email.includes(searchTerm) || 
            company.includes(searchTerm)) {
          rowElement.style.display = '';
          visibleCount++;
        } else {
          rowElement.style.display = 'none';
        }
      });

      // Actualizar contador
      if (statsBadge) {
        statsBadge.textContent = `${visibleCount} clientes`;
      }
    });

    // Manejo del modal de eliminación
    const deleteModal = document.getElementById('deleteModal');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    const clientNameSpan = document.getElementById('clientNameToDelete');
    let clientToDelete = null;

    function addDeleteEventListeners() {
      document.querySelectorAll('.delete-client').forEach(button => {
        button.addEventListener('click', (e) => {
          const target = e.target;
          clientToDelete = target.dataset.clientId || null;
          const clientName = target.dataset.clientName || '';
          
          if (clientNameSpan) {
            clientNameSpan.textContent = clientName;
          }
          
          deleteModal?.classList.remove('hidden');
        });
      });
    }

    addDeleteEventListeners();

    cancelDeleteBtn?.addEventListener('click', () => {
      deleteModal?.classList.add('hidden');
      clientToDelete = null;
    });

    confirmDeleteBtn?.addEventListener('click', async () => {
      if (clientToDelete) {
        const response = await deleteClient(clientToDelete);
        if (response.success) {
          window.location.reload();
        } else {
          alert('Error al eliminar el cliente: ' + response.error);
        }
      }
      deleteModal?.classList.add('hidden');
      clientToDelete = null;
    });

    // Cerrar modal al hacer clic fuera
    deleteModal?.addEventListener('click', (e) => {
      if (e.target === deleteModal) {
        deleteModal.classList.add('hidden');
        clientToDelete = null;
      }
    });
  </script>
</Layout>

<style>
  /* Estilos de la página de clientes - FUTURISTA NEÓN */
  .page-container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .header-info {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .header-icon {
    width: 52px;
    height: 52px;
    background: rgba(0, 180, 255, 0.15);
    border: 1px solid rgba(0, 180, 255, 0.3);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #00b4ff;
    box-shadow: 0 0 20px rgba(0, 180, 255, 0.2);
  }

  .header-icon svg {
    width: 26px;
    height: 26px;
  }

  .header-info h1 {
    font-size: 1.875rem;
    font-weight: 800;
    color: white;
    margin: 0;
    letter-spacing: -0.02em;
  }

  .header-info p {
    font-size: 0.9375rem;
    color: #94a3b8;
    margin: 0.25rem 0 0;
  }

  /* Sección de búsqueda */
  .search-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .search-wrapper {
    position: relative;
    flex: 1;
    max-width: 500px;
  }

  .search-wrapper .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    color: #00fff2;
    opacity: 0.5;
    pointer-events: none;
    transition: all 0.3s;
  }

  .search-wrapper .search-input {
    width: 100%;
    padding: 0.875rem 1rem 0.875rem 2.75rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(0, 255, 242, 0.2);
    border-radius: 12px;
    font-size: 0.9375rem;
    color: white;
    transition: all 0.3s;
  }

  .search-wrapper .search-input:focus {
    outline: none;
    border-color: #00fff2;
    background: rgba(0, 255, 242, 0.05);
    box-shadow: 0 0 20px rgba(0, 255, 242, 0.2);
  }

  .search-wrapper .search-input::placeholder {
    color: rgba(255, 255, 255, 0.3);
  }

  .stats-badge {
    display: inline-flex;
    padding: 0.5rem 1rem;
    background: rgba(191, 0, 255, 0.15);
    border: 1px solid rgba(191, 0, 255, 0.3);
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 600;
    color: #bf00ff;
  }

  /* Tabla mejorada - Glassmorphism */
  .table-container {
    background: rgba(255, 255, 255, 0.02);
    border-radius: 20px;
    border: 1px solid rgba(0, 255, 242, 0.15);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    overflow: hidden;
  }

  .table-row-animated {
    animation: fadeInRow 0.4s ease forwards;
    opacity: 0;
  }

  @keyframes fadeInRow {
    from {
      opacity: 0;
      transform: translateX(-10px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Celda de cliente */
  .client-cell {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .client-avatar {
    width: 38px;
    height: 38px;
    background: linear-gradient(135deg, #00fff2, #ff00ff);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: 700;
    color: #0a0a10;
    flex-shrink: 0;
    box-shadow: 0 0 15px rgba(0, 255, 242, 0.3);
  }

  .client-name {
    font-weight: 600;
    color: white;
  }

  /* Información de contacto */
  .contact-info {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .contact-info .email {
    font-size: 0.9375rem;
    color: white;
  }

  .contact-info .phone {
    font-size: 0.8125rem;
    color: #94a3b8;
  }

  .company-name {
    color: #cbd5e1;
  }

  .date {
    color: #94a3b8;
    font-size: 0.9375rem;
  }

  /* Botones de acción */
  .actions-cell {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.5rem;
  }

  .action-btn {
    width: 34px;
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    cursor: pointer;
    transition: all 0.3s;
    background: rgba(255, 255, 255, 0.03);
    color: rgba(255, 255, 255, 0.5);
  }

  .action-btn svg {
    width: 18px;
    height: 18px;
  }

  .action-btn.view:hover {
    background: rgba(0, 180, 255, 0.15);
    border-color: rgba(0, 180, 255, 0.4);
    color: #00b4ff;
    box-shadow: 0 0 15px rgba(0, 180, 255, 0.2);
  }

  .action-btn.edit:hover {
    background: rgba(0, 255, 242, 0.15);
    border-color: rgba(0, 255, 242, 0.4);
    color: #00fff2;
    box-shadow: 0 0 15px rgba(0, 255, 242, 0.2);
  }

  .action-btn.delete:hover {
    background: rgba(255, 45, 149, 0.15);
    border-color: rgba(255, 45, 149, 0.4);
    color: #ff2d95;
    box-shadow: 0 0 15px rgba(255, 45, 149, 0.2);
  }

  /* Estado vacío */
  .empty-table {
    text-align: center;
    padding: 4rem 2rem;
  }

  .empty-table svg {
    width: 64px;
    height: 64px;
    color: rgba(0, 255, 242, 0.3);
    margin: 0 auto 1rem;
  }

  .empty-table p {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 1.5rem;
  }

  .empty-action {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: linear-gradient(135deg, rgba(0, 255, 242, 0.2), rgba(0, 180, 255, 0.2));
    border: 1px solid #00fff2;
    color: #00fff2;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.9375rem;
    text-decoration: none;
    transition: all 0.3s;
    box-shadow: 0 0 20px rgba(0, 255, 242, 0.3);
  }

  .empty-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 30px rgba(0, 255, 242, 0.5);
    color: #00fff2;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: stretch;
    }

    .header-info {
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
    }

    .search-wrapper {
      max-width: 100%;
    }

    .actions-cell {
      flex-wrap: wrap;
    }
  }
</style>
