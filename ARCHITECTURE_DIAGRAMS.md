# ğŸ—ï¸ Arquitectura del Sistema - Diagrama Visual

## ğŸ“Š Arquitectura General

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VICTORIA CRM - ARQUITECTURA                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FRONTEND (ASTRO)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  /customers/index.astro          /customers/[id].astro        â”‚
â”‚  â”œâ”€ Lista de clientes            â”œâ”€ Detalle cliente           â”‚
â”‚  â”œâ”€ BÃºsqueda                     â”œâ”€ Alertas de suscripciÃ³n âœ¨ â”‚
â”‚  â”œâ”€ Filtros                      â”œâ”€ BotÃ³n renovar             â”‚
â”‚  â”œâ”€ PaginaciÃ³n                   â”œâ”€ Acciones                  â”‚
â”‚  â””â”€ Tarjetas                     â””â”€ Info completa             â”‚
â”‚                                                                 â”‚
â”‚  /customers/crear.astro                                        â”‚
â”‚  â”œâ”€ Formulario creaciÃ³n                                        â”‚
â”‚  â”œâ”€ Campo fecha_suscripcion âœ¨                                 â”‚
â”‚  â”œâ”€ ValidaciÃ³n                                                 â”‚
â”‚  â””â”€ EnvÃ­o a API                                                â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     API ENDPOINTS (ASTRO)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  GET  /api/customers                                           â”‚
â”‚  POST /api/customers/crear                                     â”‚
â”‚  GET  /api/customers/[id]                                      â”‚
â”‚  DELETE /api/customers/[id]                                    â”‚
â”‚                                                                  â”‚
â”‚  POST /api/notifications/subscription âœ¨                       â”‚
â”‚  â”œâ”€ Valida token                                               â”‚
â”‚  â”œâ”€ Recibe: { clienteId, nombre, email, ... }                 â”‚
â”‚  â””â”€ Llama emailService                                         â”‚
â”‚                                                                  â”‚
â”‚  GET  /api/cron/check-subscriptions âœ¨                        â”‚
â”‚  â”œâ”€ Valida CRON_SECRET                                         â”‚
â”‚  â”œâ”€ Itera clientes                                             â”‚
â”‚  â”œâ”€ Calcula vencimientos                                       â”‚
â”‚  â””â”€ EnvÃ­a emails automÃ¡ticos                                   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                 â”‚                 â”‚
            â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SERVICIOS      â”‚ â”‚   SERVICIOS      â”‚ â”‚   SERVICIOS      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚ â”‚                  â”‚ â”‚                  â”‚
â”‚ subscriptionSvc  â”‚ â”‚ emailService âœ¨  â”‚ â”‚ customerService  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚ â”‚                  â”‚ â”‚                  â”‚
â”‚ â€¢ Calcular dÃ­as  â”‚ â”‚ â€¢ Resend API     â”‚ â”‚ â€¢ CRUD            â”‚
â”‚ â€¢ Formatear      â”‚ â”‚ â€¢ HTML template  â”‚ â”‚ â€¢ ValidaciÃ³n      â”‚
â”‚ â€¢ Vencimiento    â”‚ â”‚ â€¢ Fallback log   â”‚ â”‚ â€¢ Query/Insert    â”‚
â”‚                  â”‚ â”‚ â€¢ Error handler  â”‚ â”‚ â€¢ Delete          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BASE DE DATOS                             â”‚
â”‚                      (SUPABASE/PostgreSQL)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  clientes                                                        â”‚
â”‚  â”œâ”€ id                                                           â”‚
â”‚  â”œâ”€ usuario_id                                                  â”‚
â”‚  â”œâ”€ nombre, email, telÃ©fono, empresa                            â”‚
â”‚  â”œâ”€ estado, notas                                               â”‚
â”‚  â”œâ”€ fecha_creacion                                              â”‚
â”‚  â””â”€ fecha_suscripcion âœ¨ â† Nueva columna                        â”‚
â”‚                                                                  â”‚
â”‚  subscription_notifications âœ¨ â† Nueva tabla                    â”‚
â”‚  â”œâ”€ id                                                           â”‚
â”‚  â”œâ”€ cliente_id (FK)                                             â”‚
â”‚  â”œâ”€ usuario_id (FK)                                             â”‚
â”‚  â”œâ”€ dias_restantes                                              â”‚
â”‚  â”œâ”€ notificacion_tipo                                           â”‚
â”‚  â”œâ”€ created_at                                                  â”‚
â”‚  â””â”€ updated_at                                                  â”‚
â”‚                                                                  â”‚
â”‚  Ãndices:     âœ… Optimizados                                    â”‚
â”‚  RLS:         âœ… Habilitado                                     â”‚
â”‚  Triggers:    âœ… AuditorÃ­a automÃ¡tica                           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Flujo de NotificaciÃ³n Manual

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   USUARIO ACCEDE A CLIENTE                      â”‚
â”‚              GET http://localhost:3000/customers/[id]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Cargar cliente â”‚
                    â”‚  desde BD        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ verificarYMostrarAlerta()   â”‚
                    â”‚ (En [id].astro)             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                    â”‚
        â–¼                    â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ < 7    â”‚        â”‚ 7 a 365      â”‚      â”‚ > 365    â”‚
    â”‚ dÃ­as   â”‚        â”‚ dÃ­as         â”‚      â”‚ dÃ­as     â”‚
    â”‚âœ¨ SÃ  â”‚        â”‚ NO           â”‚      â”‚ NO       â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Mostrar alerta roja: â”‚
    â”‚ âš ï¸ Vence en X dÃ­as   â”‚
    â”‚                      â”‚
    â”‚ [ğŸ”„ Renovar]         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ enviarNotificacion()          â”‚
    â”‚ (FunciÃ³n JavaScript)          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ POST /api/notifications/subscription
    â”‚                                 â”‚
    â”‚ Body:                           â”‚
    â”‚ {                               â”‚
    â”‚   clienteId: uuid,              â”‚
    â”‚   nombre: string,               â”‚
    â”‚   email: string,                â”‚
    â”‚   diasRestantes: number,        â”‚
    â”‚   fechaSuscripcion: date,       â”‚
    â”‚   fechaVencimiento: date        â”‚
    â”‚ }                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ API: /api/notifications/         â”‚
    â”‚      subscription.ts             â”‚
    â”‚                                  â”‚
    â”‚ 1. Valida token âœ…              â”‚
    â”‚ 2. Valida parÃ¡metros âœ…         â”‚
    â”‚ 3. Llama emailService.ts âœ…     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚
        â–¼                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Intenta        â”‚  â”‚ Fallback:           â”‚
    â”‚ Resend API     â”‚  â”‚ console.log()       â”‚
    â”‚                â”‚  â”‚ (Desarrollo)        â”‚
    â”‚ SI SUCCESS:    â”‚  â”‚                     â”‚
    â”‚ âœ… Email sent  â”‚  â”‚ âœ… Log en consola   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Registrar en                 â”‚
    â”‚ subscription_notifications   â”‚
    â”‚                              â”‚
    â”‚ INSERT {                     â”‚
    â”‚   cliente_id: uuid,          â”‚
    â”‚   usuario_id: uuid,          â”‚
    â”‚   dias_restantes: number,    â”‚
    â”‚   notificacion_tipo: string, â”‚
    â”‚   created_at: now()          â”‚
    â”‚ }                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Retornar al cliente:         â”‚
    â”‚                              â”‚
    â”‚ {                            â”‚
    â”‚   success: true,             â”‚
    â”‚   message: "Email enviado"   â”‚
    â”‚ }                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## â±ï¸ Flujo de NotificaciÃ³n AutomÃ¡tica (Cron Job)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        CRON JOB DIARIO (8:00 AM UTC)                     â”‚
â”‚   GET /api/cron/check-subscriptions                      â”‚
â”‚   Headers: { Authorization: Bearer {CRON_SECRET} }       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Validar CRON_SECRET          â”‚
    â”‚                              â”‚
    â”‚ IF NOT VALID:                â”‚
    â”‚ â†’ 401 Unauthorized           â”‚
    â”‚                              â”‚
    â”‚ IF VALID:                    â”‚
    â”‚ â†’ Continuar âœ…              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Obtener TODOS los clientes de BD       â”‚
    â”‚                                        â”‚
    â”‚ SELECT * FROM clientes                 â”‚
    â”‚ ORDER BY fecha_suscripcion DESC        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ PARA CADA cliente:                     â”‚
    â”‚                                        â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚ 1. Calcular dÃ­as restantes        â”‚ â”‚
    â”‚ â”‚    fecha_vencimiento =            â”‚ â”‚
    â”‚ â”‚    fecha_suscripcion + 365 dÃ­as   â”‚ â”‚
    â”‚ â”‚                                    â”‚ â”‚
    â”‚ â”‚    dias_restantes =               â”‚ â”‚
    â”‚ â”‚    fecha_vencimiento - hoy        â”‚ â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                        â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚ 2. Evaluar condiciÃ³n:              â”‚ â”‚
    â”‚ â”‚                                    â”‚ â”‚
    â”‚ â”‚ IF dias_restantes < 7:             â”‚ â”‚
    â”‚ â”‚   â†’ NECESITA NOTIFICACIÃ“N          â”‚ â”‚
    â”‚ â”‚                                    â”‚ â”‚
    â”‚ â”‚ ELIF dias_restantes <= 0:          â”‚ â”‚
    â”‚ â”‚   â†’ VENCIDO - EMAIL URGENTE       â”‚ â”‚
    â”‚ â”‚                                    â”‚ â”‚
    â”‚ â”‚ ELSE:                              â”‚ â”‚
    â”‚ â”‚   â†’ SKIP (no necesita)             â”‚ â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                        â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚ 3. Verificar Ãºltima notificaciÃ³n   â”‚ â”‚
    â”‚ â”‚                                    â”‚ â”‚
    â”‚ â”‚ SELECT created_at FROM             â”‚ â”‚
    â”‚ â”‚ subscription_notifications         â”‚ â”‚
    â”‚ â”‚ WHERE cliente_id = ...             â”‚ â”‚
    â”‚ â”‚ ORDER BY created_at DESC           â”‚ â”‚
    â”‚ â”‚ LIMIT 1                            â”‚ â”‚
    â”‚ â”‚                                    â”‚ â”‚
    â”‚ â”‚ IF (ahora - Ãºltima) < 24 horas:    â”‚ â”‚
    â”‚ â”‚   â†’ SKIP (ya se enviÃ³)             â”‚ â”‚
    â”‚ â”‚                                    â”‚ â”‚
    â”‚ â”‚ ELSE:                              â”‚ â”‚
    â”‚ â”‚   â†’ ENVIAR EMAIL âœ…               â”‚ â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                        â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚ 4. Enviar email (si aplica):       â”‚ â”‚
    â”‚ â”‚                                    â”‚ â”‚
    â”‚ â”‚ emailService.enviarNotificacion()  â”‚ â”‚
    â”‚ â”‚ â”œâ”€ Intenta Resend API             â”‚ â”‚
    â”‚ â”‚ â”œâ”€ Fallback a console.log()       â”‚ â”‚
    â”‚ â”‚ â””â”€ await result                   â”‚ â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                        â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚ 5. Registrar en BD:                â”‚ â”‚
    â”‚ â”‚                                    â”‚ â”‚
    â”‚ â”‚ INSERT INTO                        â”‚ â”‚
    â”‚ â”‚ subscription_notifications:        â”‚ â”‚
    â”‚ â”‚ {                                  â”‚ â”‚
    â”‚ â”‚   cliente_id: uuid,                â”‚ â”‚
    â”‚ â”‚   usuario_id: uuid,                â”‚ â”‚
    â”‚ â”‚   dias_restantes: number,          â”‚ â”‚
    â”‚ â”‚   notificacion_tipo: 'proxima...'  â”‚ â”‚
    â”‚ â”‚   created_at: now()                â”‚ â”‚
    â”‚ â”‚ }                                  â”‚ â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                        â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚ 6. Incrementar contadores:         â”‚ â”‚
    â”‚ â”‚                                    â”‚ â”‚
    â”‚ â”‚ notificaciones_enviadas++          â”‚ â”‚
    â”‚ â”‚ clientes_procesados.push(cliente)  â”‚ â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼ (despuÃ©s de todos los clientes)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Retornar Resultado:                    â”‚
    â”‚                                        â”‚
    â”‚ {                                      â”‚
    â”‚   success: true,                       â”‚
    â”‚   total_clientes: 100,                 â”‚
    â”‚   notificaciones_enviadas: 5,          â”‚
    â”‚   errores: 0,                          â”‚
    â”‚   clientes_procesados: [               â”‚
    â”‚     { id, nombre, email },             â”‚
    â”‚     ...                                â”‚
    â”‚   ],                                   â”‚
    â”‚   timestamp: "2025-11-15T08:00:00Z"   â”‚
    â”‚ }                                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Flujo de Seguridad

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          AUTENTICACIÃ“N Y AUTORIZACIÃ“N               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. LOGIN (POST /api/auth/login)
   â”œâ”€ Email + Password
   â”œâ”€ Valida con Supabase Auth
   â”œâ”€ Crea sesiÃ³n
   â””â”€ Guarda tokens en cookies httpOnly
      â”œâ”€ sb-access-token
      â”œâ”€ sb-refresh-token
      â””â”€ sb-user-id

2. ACCESO A RUTA PROTEGIDA
   â”œâ”€ Middleware.ts verifica cookie
   â”œâ”€ SI vÃ¡lido â†’ Accede âœ…
   â””â”€ SI no vÃ¡lido â†’ Redirecciona a /auth/login

3. LLAMADA A API (/api/notifications/subscription)
   â”œâ”€ Obtiene token de cookie
   â”œâ”€ Valida con Supabase
   â”œâ”€ Extrae usuario_id
   â”œâ”€ Verifica que cliente pertenece al usuario
   â””â”€ SI vÃ¡lido â†’ Ejecuta âœ…
   â””â”€ SI no vÃ¡lido â†’ Error 401/403

4. LLAMADA A CRON JOB (/api/cron/check-subscriptions)
   â”œâ”€ Verifica header Authorization
   â”œâ”€ Compara con CRON_SECRET
   â”œâ”€ SI vÃ¡lido â†’ Ejecuta âœ…
   â””â”€ SI no vÃ¡lido â†’ Error 401

5. BASE DE DATOS (RLS)
   â”œâ”€ Para cada query:
   â”œâ”€ BD verifica usuario_id
   â”œâ”€ SI propietario â†’ Retorna datos âœ…
   â””â”€ SI no propietario â†’ Error/null
```

---

## ğŸ“Š Componentes Clave

```
SERVICIOS:
â”œâ”€â”€ subscriptionService.ts
â”‚   â”œâ”€ calcularDiasRestantes()
â”‚   â”œâ”€ formatearFechaSuscripcion()
â”‚   â””â”€ calcularFechaVencimiento()
â”‚
â””â”€â”€ emailService.ts
    â”œâ”€ enviarEmailNotificacionVencimiento()
    â””â”€ enviarEmailNotificacionVencimientoSimple()

PÃGINAS:
â”œâ”€â”€ /customers
â”‚   â”œâ”€ Listar clientes
â”‚   â””â”€ Buscar/Filtrar
â”‚
â”œâ”€â”€ /customers/crear
â”‚   â”œâ”€ Formulario creaciÃ³n
â”‚   â””â”€ Input fecha_suscripcion
â”‚
â””â”€â”€ /customers/[id]
    â”œâ”€ Mostrar alerta (< 7 dÃ­as) âœ¨
    â”œâ”€ Enviar notificaciÃ³n âœ¨
    â””â”€ Acciones

ENDPOINTS:
â”œâ”€â”€ GET  /api/customers
â”œâ”€â”€ POST /api/customers/crear
â”œâ”€â”€ GET  /api/customers/[id]
â”œâ”€â”€ DELETE /api/customers/[id]
â”œâ”€â”€ POST /api/notifications/subscription âœ¨
â””â”€â”€ GET  /api/cron/check-subscriptions âœ¨

BD:
â”œâ”€â”€ clientes
â”‚   â””â”€ fecha_suscripcion âœ¨
â””â”€â”€ subscription_notifications âœ¨
    â””â”€ Registro de alertas
```

---

## ğŸ¯ Timeline del Procesamiento

```
SCENARIO 1: Usuario accede a cliente (< 7 dÃ­as)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

0ms    Solicitud GET /customers/[id]
â”Š
50ms   BD: SELECT * FROM clientes
â”Š
100ms  JavaScript: Calcular dÃ­as
â”Š
105ms  CondiciÃ³n: Â¿< 7 dÃ­as?
â”Š
110ms  SÃ â†’ Mostrar alerta en UI
â”‚
150ms  Llamar: POST /api/notifications/subscription
â”‚
200ms  API: Validar token
â”‚
210ms  API: Llamar emailService
â”‚
250ms  Email: Resend API (async)
â”‚      â””â”€ ContinÃºa en background
â”‚
350ms  BD: INSERT subscription_notifications
â”‚
360ms  Retornar respuesta al cliente âœ…
â”‚
[...] (background) Email enviado por Resend


SCENARIO 2: Cron job diario
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

00:00s GET /api/cron/check-subscriptions
â”‚
01:00s BD: SELECT ALL clientes (100 registros)
â”‚
01:50s Loop: Para cada cliente
â”‚      â”œâ”€ Calcular dÃ­as
â”‚      â”œâ”€ Verificar Ãºltima notificaciÃ³n
â”‚      â””â”€ Decidir si enviar
â”‚
02:50s Email: Enviar 5 emails (async batch)
â”‚
03:00s BD: INSERT 5 registros notificaciones
â”‚
03:50s Retornar resultado âœ…
â”‚
[...] (background) Emails procesÃ¡ndose
```

---

## ğŸ“ˆ Escalabilidad

```
DISEÃ‘O PARA ESCALAR:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Clientes:      10    100    1000   10000  100000
Tiempo query:  5ms   15ms   50ms   200ms  500ms
Emails:        0.5s  2s     15s    120s   600s
Ãndices:       âœ…    âœ…     âœ…     âœ…     âœ…
CachÃ©:         - (se puede agregar)
Batch emails:  - (se puede agregar)
Async workers: - (se puede agregar)

MEJORAS FUTURAS:
â”œâ”€ Caching con Redis
â”œâ”€ Email batch processing
â”œâ”€ Async workers (Bull, Resque)
â”œâ”€ Database replication
â””â”€ CDN para assets
```

---

Este documento proporciona una visiÃ³n clara de cÃ³mo estÃ¡ estructurado y funciona el sistema de notificaciones de suscripciÃ³n.
